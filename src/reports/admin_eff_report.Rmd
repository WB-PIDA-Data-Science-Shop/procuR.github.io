---
title: "Administrative Efficiency Report"
author: "Viktoriia Poltoratskaia"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide   # or "show"
---
This section provides an overview of the administrative barriers to the implementation of public procurement. Such barriers may arise from limited resources available to public buyers, insufficient staff capacity (e.g., staff shortages or low qualifications), an overload of procurement procedures, or inadequate regulation. The analysis focuses on identifying the most common symptoms of these administrative barriers, including the distribution of procurement procedure types, the occurrence of delays, the proportion of cancelled tenders, and other related indicators. 

### <span style="color:red; font-weight:bold">Is there an overuse of some procedure types?</span>

Requires manual filling

### Regulatory overview of procedure type thresholds and conditions

| Procedure Type                                | Level of competition      | Conditions / When used                                                                                                                                                                                                 | Threshold (value / complexity)                            | Deadline requirements (Submission / Decision) |
|:----------------------------------------------|:--------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:----------------------------------------------------------|:----------------------------------------------|
| Open Procedure                                | Competitive               | Default choice, anyone can bid.                                                                                                                                                                                        | Mandatory above X value, optional below.                  | Submission: ___  /  Decision: ___            |
| Restricted Procedure / approaching bidders    | Competitive but limited   | Used for complex or high-value tenders where only qualified firms are invited to submit full offers.                                                                                                                   | Usually higher value / complex tenders.                   | Submission: ___  /  Decision: ___            |
| Negotiated Procedure with Prior Publication   | Competitive but limited   | Complex projects which cannot have strictly defined requirements in advance; pre-selection of capable suppliers.                                                                                                      | Usually higher value / complex tenders.                   | Submission: ___  /  Decision: ___            |
| Competitive Dialogue                          | Competitive but limited   | The contract is particularly complex and the authority cannot define the technical means to meet its needs, or the legal or financial make-up of the project; pre-selection of capable suppliers.                     | Usually higher value / complex tenders.                   | Submission: ___  /  Decision: ___            |
| Concession                                    | Competitive but limited   | Remuneration for the supplier comes from revenues generated by operating the service or infrastructure; pre-selection of capable suppliers.                                                                           | Usually complex infrastructural / service projects.       | Submission: ___  /  Decision: ___            |
| Innovation Partnership                        | Competitive but limited   | Joint R&D and purchase of innovative product; competitive entry and long-term partnership after; pre-selection of capable suppliers.                                                                                  | Complex / innovative projects.                            | Submission: ___  /  Decision: ___            |
| Design contest                                | Competitive               | Open submission of project designs (architecture, urban planning, engineering, etc.).                                                                                                                                  | Projects requiring design submission.                     | Submission: ___  /  Decision: ___            |
| Mini-tender                                   | Competitive but limited   | Second stage in framework agreements or DPS for pre-selected suppliers; invitation sent only to framework / DPS suppliers qualified for that lot/category.                                                            | Invitation sent only to suppliers qualified for that lot. | Submission: ___  /  Decision: ___            |
| Negotiated Procedure without Prior Publication| Non-competitive           | Contracting authority directly approaches one or more suppliers under exceptional, legally defined conditions. Allowed only under strict circumstances (no competition, extreme urgency, or failed competitive tender). | Allowed only under strict legal circumstances.            | Submission: ___  /  Decision: ___            |
| Direct Award / Single Source                  | Non-competitive           | Direct purchase from supplier without competition. Used for very low-value purchases or specific exceptions.                                                                                                          | Below X value or specific exceptions.                     | Submission: ___  /  Decision: ___            |

**Tendering techniques**

| Tendering technique  | Level of competition    | Conditions / When used                                                                                                                                                                                                                                         | Threshold / relation to procedure                          | Deadlines / relation to procedure             |
|:---------------------|:------------------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-----------------------------------------------------------|:----------------------------------------------|
| Dynamic Purchasing System (DPS) | Competitive              | Electronic system for recurring, standard items. Suppliers can apply to join at any time.                                                                                                                                                                      | Same as for open / mini-tender.                           | Same as for open / mini-tender.              |
| Framework Agreement  | Competitive but limited | Long-term contract arrangement between one or more contracting authorities and one or more suppliers that sets terms (price, quantities, quality, etc.) for future purchases. Can result in a single supplier (no competition at second stage) or multiple suppliers (mini-tender at second stage). | Depending on the underlying procedure(s) used.             | Depending on the underlying procedure(s).     |

*Source: relevant regulations; MAPS, etc.*


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo   = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width  = 14,
  fig.height = 12,
  out.width = "100%"
)

# Source your helper + pipeline functions
source("C:/Users/wb589991/OneDrive - WBG/Documents/procuR.github.io/src/utils/admin_utils.R")

# Load packages
required_packages <- c(
  "data.table", "tidyverse", "patchwork", "corrr",
  "giscoR", "eurostat", "sf", "tidytext",
  "fixest", "ggeffects", "igraph", "ggraph", "purrr",
  "kableExtra", "ggrepel"
)

load_packages <- function(pkgs) {
  installed  <- rownames(installed.packages())
  to_install <- setdiff(pkgs, installed)
  if (length(to_install) > 0) install.packages(to_install)
  invisible(lapply(pkgs, library, character.only = TRUE))
}

load_packages(required_packages)
```

```{r multi-country-setup, include=FALSE}
base_dir      <- "C:/Users/wb589991/Downloads"
country_codes <- c("BG", "UY")

results_list <- map(country_codes, function(cc) {
  # Input: Read from C:/Users/wb589991/Downloads/COUNTRYCODE_export/COUNTRYCODE_export.csv
  input_dir <- file.path(base_dir, paste0(cc, "_export"))
  input_path <- file.path(input_dir, paste0(cc, "_export.csv"))
  
  # Output: Save to C:/Users/wb589991/Downloads/COUNTRYCODE_export/output/
  output_dir <- file.path(input_dir, "output")
  
  dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)
  
  df <- load_data(input_path)
  run_admin_efficiency_pipeline(
    df           = df,
    country_code = cc,
    output_dir   = output_dir
  )
})

names(results_list) <- country_codes
```

```{r helpers-render-tbl, echo=FALSE, message=FALSE, warning=FALSE}
render_tbl <- function(x,
                       digits = 3,
                       caption = NULL,
                       max_rows = 30,
                       collapse_html = TRUE,
                       details_open = FALSE) {

  if (is.null(x) || (is.data.frame(x) && nrow(x) == 0L)) {
    cat("*No rows to display.*\n\n")
    return(invisible(NULL))
  }

  x <- as.data.frame(x)

  if (!is.null(max_rows) && is.finite(max_rows) && nrow(x) > max_rows) {
    x_show <- x[seq_len(max_rows), , drop = FALSE]
    note <- paste0("Showing first ", max_rows, " of ", nrow(x), " rows.")
  } else {
    x_show <- x
    note <- NULL
  }

  is_html <- knitr::is_html_output()
  is_latex <- knitr::is_latex_output()

  k <- knitr::kable(
    x_show,
    format = if (is_html) "html" else if (is_latex) "latex" else "simple",
    digits = digits,
    caption = caption,
    booktabs = is_latex,
    longtable = is_latex
  )

  if (requireNamespace("kableExtra", quietly = TRUE)) {
    if (is_html) {
      k <- kableExtra::kable_styling(
        k,
        full_width = FALSE,
        bootstrap_options = c("striped", "hover", "condensed", "responsive")
      )
    } else if (is_latex) {
      k <- kableExtra::kable_styling(k, latex_options = c("hold_position"))
    }
  }

  if (is_html && collapse_html) {
    cat(sprintf(
      "<details %s>\n<summary>%s</summary>\n\n",
      if (details_open) "open" else "",
      if (!is.null(caption)) caption else "Table"
    ))
    cat(k)
    cat("\n\n</details>\n\n")
  } else {
    cat(k)
    cat("\n\n")
  }

  if (!is.null(note)) cat(paste0("*", note, "*\n\n"))

  invisible(NULL)
}

# Safety helpers
safe_first_num <- function(x) {
  if (is.null(x) || length(x) == 0) return(NA_real_)
  suppressWarnings(as.numeric(x[[1]]))
}

has_rows <- function(df) is.data.frame(df) && nrow(df) > 0

get_first_num <- function(df, candidates) {
  if (!is.data.frame(df)) return(NA_real_)
  for (nm in candidates) {
    if (nm %in% names(df)) return(safe_first_num(df[[nm]]))
  }
  NA_real_
}

print_sensitivity_bundle_compact <- function(results,
                                             bundle_name,
                                             title = NULL,
                                             description = NULL,
                                             max_rows = 20,
                                             collapse_html = TRUE,
                                             missing_msg = "Sensitivity bundle not available.") {
  # Access bundle from results
  bun <- results[[bundle_name]]

  # Check if bundle exists
  if (is.null(bun) || length(bun) == 0) {
    cat("*", missing_msg, "*\n\n", sep = "")
    return(invisible(NULL))
  }

  # Require overall panel to interpret anything
  if (!has_rows(bun$overall)) {
    cat("*", missing_msg, "*\n\n", sep = "")
    return(invisible(NULL))
  }

  # Print title if provided
  if (!is.null(title)) {
    cat("#### ", title, "\n\n", sep = "")
  }

  # Print description if provided
  if (!is.null(description)) {
    cat(description, "\n\n")
  }

  # Interpretive guidance
  cat("**What is sensitivity analysis?**\n\n")
  cat("Sensitivity analysis tests whether the relationship between the timing indicator and single-bidding ",
      "holds across different modeling choices. ",
      "A robust finding should be consistent across reasonable variations in:\n\n")
  cat("- **Fixed effects (FE):** Controls for unobserved differences across buyers, years, etc.\n")
  cat("- **Clustering:** Adjusts standard errors for correlation within groups\n")
  cat("- **Control variables:** Additional factors that might affect the outcome\n\n")

  # Overall summary
  summary_panel <- dplyr::bind_cols(bun$overall, bun$sign)

  cat("**Overall Summary:**\n\n")
  render_tbl(summary_panel, caption = NULL, max_rows = Inf, collapse_html = FALSE)

  # Interpretation
  cat("\n**How to interpret:**\n\n")

  # Extract summary stats
  n_specs      <- get_first_num(bun$overall, c("n_specs"))
  share_pos    <- get_first_num(bun$overall, c("share_positive"))
  share_neg    <- get_first_num(bun$overall, c("share_negative"))

  median_est   <- get_first_num(bun$overall, c("median_estimate"))
  median_p     <- get_first_num(bun$overall, c("median_pvalue"))
  median_str   <- get_first_num(bun$overall, c("median_strength"))

  share_p05    <- get_first_num(bun$overall, c("share_p_le_0.05"))
  share_p10    <- get_first_num(bun$overall, c("share_p_le_0.1", "share_p_le_0.10"))
  share_p20    <- get_first_num(bun$overall, c("share_p_le_0.2", "share_p_le_0.20"))

  sign_stable  <- get_first_num(bun$sign, c("share_sign_stable"))
  n_nonzero    <- get_first_num(bun$sign, c("n_nonzero"))

  # Print metric descriptions
  if (!is.na(n_specs))   cat("- **n_specs (", n_specs, "):** Number of alternative model specifications tested\n", sep = "")
  if (!is.na(n_nonzero)) cat("- **n_nonzero (", n_nonzero, "):** Number of specifications with non-zero estimates\n", sep = "")
  if (!is.na(share_pos)) cat("- **share_positive (", sprintf("%.1f%%", 100*share_pos), "):** ", 
                              "Percentage of specifications where the estimate is positive\n", sep = "")
  if (!is.na(share_neg)) cat("- **share_negative (", sprintf("%.1f%%", 100*share_neg), "):** ", 
                              "Percentage of specifications where the estimate is negative\n", sep = "")
  if (!is.na(median_est)) cat("- **median_estimate (", sprintf("%.3f", median_est), "):** ", 
                               "Typical size of the estimated effect across specifications\n", sep = "")
  if (!is.na(median_p)) cat("- **median_pvalue (", sprintf("%.3f", median_p), "):** ", 
                             "Typical p-value; lower values indicate stronger statistical evidence\n", sep = "")
  if (!is.na(median_str)) cat("- **median_strength (", sprintf("%.3f", median_str), "):** ", 
                               "Effect size when moving from 10th to 90th percentile of the timing indicator\n", sep = "")
  if (!is.na(share_p05)) cat("- **share_p_le_0.05 (", sprintf("%.1f%%", 100*share_p05), "):** ", 
                              "Percentage of specs statistically significant at 5% level\n", sep = "")
  if (!is.na(share_p10)) cat("- **share_p_le_0.1 (", sprintf("%.1f%%", 100*share_p10), "):** ", 
                              "Percentage of specs statistically significant at 10% level\n", sep = "")
  if (!is.na(share_p20)) cat("- **share_p_le_0.2 (", sprintf("%.1f%%", 100*share_p20), "):** ", 
                              "Percentage of specs statistically significant at 20% level\n", sep = "")
  if (!is.na(sign_stable)) {
    stable_yn <- if (sign_stable >= 0.99) "Yes" else "No"
    cat("- **share_sign_stable (", stable_yn, "):** ",
        "Whether all non-zero estimates have the same sign (positive or negative)\n", sep = "")
  }

  # Key takeaway
  cat("\n**Key takeaway:**\n")
  if (!is.na(share_p10) && share_p10 >= 0.6) {
    cat("- More than 60% of specifications are significant at p < 0.10, suggesting the finding is robust across different modeling choices.\n")
  } else if (!is.na(share_p10) && share_p10 >= 0.4) {
    cat("- About 40-60% of specifications are significant at p < 0.10, suggesting moderate robustness.\n")
  } else if (!is.na(share_p10)) {
    cat("- Less than 40% of specifications are significant at p < 0.10, suggesting the finding may be sensitive to modeling choices.\n")
  }
  
  if (!is.na(sign_stable) && sign_stable >= 0.99) {
    cat("- The sign of the estimate is stable across all specifications, indicating consistent direction of the effect.\n")
  } else if (!is.na(sign_stable)) {
    cat("- The sign of the estimate varies across specifications, suggesting the direction of the effect is uncertain.\n")
  }

  cat("\n")

  # Detailed tables
  cat("**Breakdown by modeling choice:**\n\n")
  
  if (has_rows(bun$by_fe)) {
    render_tbl(bun$by_fe, caption = "Results by Fixed Effects", 
               max_rows = max_rows, collapse_html = collapse_html)
  }
  
  if (has_rows(bun$by_cluster)) {
    render_tbl(bun$by_cluster, caption = "Results by Clustering Method", 
               max_rows = max_rows, collapse_html = collapse_html)
  }
  
  if (has_rows(bun$by_controls)) {
    render_tbl(bun$by_controls, caption = "Results by Control Variables", 
               max_rows = max_rows, collapse_html = collapse_html)
  }
  
  if (has_rows(bun$classes)) {
    render_tbl(bun$classes, caption = "Classification of Specifications", 
               max_rows = max_rows, collapse_html = collapse_html)
  }
  
  if (has_rows(bun$top_cells)) {
    render_tbl(bun$top_cells, caption = "Top Performing Specification Combinations", 
               max_rows = 10, collapse_html = collapse_html)
  }

  invisible(NULL)
}
```

```{r helpers-report, echo=FALSE}
# Helper to print a ggplot (or message) plus text around it
print_result_plot <- function(results,
                              obj_name,
                              title,
                              description = NULL,
                              missing_msg = "Figure not produced: no information or key variable is missing for the plot.") {
  # Pull object from list by name
  obj <- results[[obj_name]]
  
  # Section title
  cat("#### ", title, "\n\n", sep = "")
  
  # Optional description paragraph
  if (!is.null(description)) {
    cat(description, "\n\n")
  }
  
  # If it's a ggplot, print it
  if (inherits(obj, "gg")) {
    print(obj)
    cat("\n\n")
  } else {
    cat("*", missing_msg, "*\n\n", sep = "")
  }
}

render_country_results <- function(cc, results_list) {
  results <- results_list[[cc]]
  
  if (is.null(results)) {
    cat("*No results available for ", cc, ".*\n\n", sep = "")
    return(invisible(NULL))
  }
  
  # ================================================================
  # 1. Procedure mix
  # ================================================================
  cat("#### <span style=\"color:red; font-weight:bold\">Is there an overuse of some procedure types?</span>\n\n")
  
  print_result_plot(
    results,
    obj_name    = "combined_proc",
    title       = paste("Procedure type distribution –", cc),
    description = paste(
      "This panel shows how tenders are distributed across different procedure types.",
      "The left plot displays the share of each procedure type, while the right shows absolute counts.",
      "A high reliance on non-competitive procedures (such as direct awards or negotiated without publication)",
      "may indicate limited competition or potential misuse of exceptional procurement rules."
    )
  )
  
  # ================================================================
  # 2. Submission periods
  # ================================================================
  cat("#### <span style=\"color:red; font-weight:bold\">Are submission periods too short?</span>\n\n")
  
  print_result_plot(
    results,
    obj_name    = "subm",
    title       = paste("Overall submission period distribution –", cc),
    description = paste(
      "This histogram shows the distribution of submission periods (days from call for tender to bid deadline).",
      "Vertical lines mark the 25th percentile (Q1), median, and 75th percentile (Q3).",
      "Very short submission periods may prevent suppliers from preparing competitive bids,",
      "reducing competition and potentially favoring incumbents who are already familiar with the buyer's requirements."
    )
  )
  
  print_result_plot(
    results,
    obj_name    = "subm_proc_facet_q",
    title       = paste("Submission periods by procedure type –", cc),
    description = paste(
      "This faceted histogram breaks down submission periods by procedure type.",
      "Each panel shows quartiles for that specific procedure.",
      "More complex procedures (restricted, negotiated with publication) typically require longer preparation times,",
      "while open procedures should still allow sufficient time for suppliers to respond.",
      "Compare these distributions to regulatory minimums to identify systematic underuse of adequate submission windows."
    )
  )
  
  print_result_plot(
    results,
    obj_name    = "subm_r",
    title       = paste("Short vs. normal submission periods –", cc),
    description = paste(
      "This histogram highlights submission periods flagged as unusually short (in red) compared to normal periods (in blue).",
      "The flagging is based on country-specific thresholds or, if unavailable, the median for each procedure type.",
      "A high proportion of short submission periods may indicate that buyers are not allowing adequate time for competitive bidding,",
      "which can reduce the number of bidders and lead to less competitive outcomes."
    )
  )
  
  # ================================================================
  # 3. Who sets the shortest submission periods?
  # ================================================================
  cat("#### <span style=\"color:red; font-weight:bold\">Which buyers set the shortest submission periods?</span>\n\n")
  
  print_result_plot(
    results,
    obj_name    = "combined_short_buyer",
    title       = paste("Short submission periods by buyer group –", cc),
    description = paste(
      "These stacked bar charts show which buyer groups most frequently use short submission periods.",
      "The left panel displays counts, while the right panel shows contract values.",
      "If certain buyer types (e.g., national vs. regional) systematically use short deadlines,",
      "this may point to specific capacity constraints or procurement practices that merit closer examination.",
      "High-value contracts with short deadlines are particularly concerning as they affect larger market segments."
    )
  )
  
  # ================================================================
  # 4. Decision periods
  # ================================================================
  cat("#### <span style=\"color:red; font-weight:bold\">Are decision periods too long?</span>\n\n")
  
  print_result_plot(
    results,
    obj_name    = "decp",
    title       = paste("Overall decision period distribution –", cc),
    description = paste(
      "This histogram shows the distribution of decision periods (days from award decision to contract signature).",
      "Long decision periods can delay project implementation and create uncertainty for suppliers.",
      "While some procedures naturally take longer due to complexity or legal requirements,",
      "consistently prolonged decisions may indicate administrative bottlenecks or lack of resources."
    )
  )
  
  print_result_plot(
    results,
    obj_name    = "decp_proc_facet_q",
    title       = paste("Decision periods by procedure type –", cc),
    description = paste(
      "This faceted histogram shows decision periods broken down by procedure type, with quartile markers.",
      "This allows you to see whether more complex procedures take appropriately longer to evaluate,",
      "and whether simpler procedures are decided more quickly.",
      "Pay attention to procedure types where decisions are routinely much slower than others,",
      "or where complex tenders appear to be decided as quickly as simple ones."
    )
  )
  
  print_result_plot(
    results,
    obj_name    = "decp_r",
    title       = paste("Long vs. normal decision periods –", cc),
    description = paste(
      "This histogram highlights decision periods flagged as unusually long (in red) compared to normal periods (in green).",
      "A high proportion of long decisions suggests systematic delays,",
      "which can undermine predictability for suppliers and stall public projects."
    )
  )
  
  # ================================================================
  # 5. Who has the longest decisions? (by buyer group)
  # ================================================================
  cat("#### <span style=\"color:red; font-weight:bold\">Which buyers have the longest decision periods?</span>\n\n")
  
  print_result_plot(
    results,
    obj_name    = "combined_dec_plot",
    title       = paste("Long decision periods by buyer group –", cc),
    description = paste(
      "These stacked bar charts show which buyer groups most frequently experience long decision periods.",
      "The left panel displays contract counts, while the right panel shows contract values.",
      "High shares of delayed decisions in a specific buyer group may indicate bottlenecks in evaluation,",
      "internal approval, or oversight procedures that need to be addressed."
    )
  )
  
  # ================================================================
  # 6. Does administrative efficiency affect competition?
  # ================================================================
  cat("#### <span style=\"color:red; font-weight:bold\">Is administrative efficiency linked to competition?</span>\n\n")
  
  print_result_plot(
    results,
    obj_name    = "plot_short_reg",
    title       = paste("Effect of short submission periods on single bidding –", cc),
    description = paste(
      "This figure summarizes how the likelihood of single bidding changes when submission periods are unusually short.",
      "The model-based prediction accounts for differences in buyer type, procedure type, and year.",
      "If the line for short deadlines sits noticeably higher, this suggests that tight timelines",
      "may be restricting competition and making single bidding more likely.",
      "The shaded area represents the 95% confidence interval around the prediction."
    )
  )
  
  # Sensitivity analysis for short submission
  print_sensitivity_bundle_compact(
    results,
    bundle_name = "sensitivity_short",
    title = paste("Sensitivity Analysis: Short Submission Period Model –", cc),
    description = paste(
      "This section tests the robustness of the short submission period finding across different model specifications.",
      "The pipeline runs multiple versions of the logit model with varying combinations of:",
      "fixed effects (buyer FE, year FE, or both), clustering (by buyer, year, or buyer type),",
      "and control variables (procedure type, buyer type).",
      "Use this analysis to verify that the core finding about short submission periods and single-bidding",
      "holds across reasonable modeling choices and is not driven by a single specification."
    ),
    collapse_html = TRUE
  )
  
  print_result_plot(
    results,
    obj_name    = "plot_long_reg",
    title       = paste("Effect of long decision periods on single bidding –", cc),
    description = paste(
      "This figure assesses whether very long decision periods are associated with single bidding.",
      "The horizontal axis compares tenders decided within a normal time frame to those with delayed decisions.",
      "The vertical axis shows the predicted probability of single bidding, after accounting for buyer type and year.",
      "A higher predicted probability for delayed decisions may indicate strategic behavior",
      "or weakened competitive pressure in tenders that drag on."
    )
  )
  
  # Sensitivity analysis for long decision
  print_sensitivity_bundle_compact(
    results,
    bundle_name = "sensitivity_long",
    title = paste("Sensitivity Analysis: Long Decision Period Model –", cc),
    description = paste(
      "This section tests the robustness of the long decision period finding across different model specifications.",
      "The pipeline runs multiple versions of the logit model with varying combinations of:",
      "fixed effects (buyer FE, year FE, or both), clustering (by buyer, year, or buyer type),",
      "and control variables (procedure type, buyer type).",
      "Use this analysis to assess whether the relationship between long decision periods and single bidding",
      "is consistent across different modeling assumptions."
    ),
    collapse_html = TRUE
  )
}

```

## Country-specific results {.tabset}

### Bulgaria (BG)
```{r country-BG, echo=FALSE, results='asis'}
render_country_results("BG", results_list)
```

### Uruguay (UY)
```{r country-UY, echo=FALSE, results='asis'}
render_country_results("UY", results_list)
```


## {-}
```{r show-utils, echo=FALSE, results='asis'}
utils_path <- "C:/Users/wb589991/OneDrive - WBG/Documents/procuR.github.io/src/utils/admin_utils.R"
utils_code <- readLines(utils_path, warn = FALSE)
cat('<details><summary><b>Show underlying code</b></summary>\n')
cat('\n```r\n')
cat(paste(utils_code, collapse = "\n"))
cat('\n```\n')
cat('</details>\n')
```