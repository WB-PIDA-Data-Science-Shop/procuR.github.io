---
title: "Administrative Efficiency Report"
author: "Viktoriia Poltoratskaia"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide   # or "show"
---
This section provides an overview of the administrative barriers to the implementation of public procurement. Such barriers may arise from limited resources available to public buyers, insufficient staff capacity (e.g., staff shortages or low qualifications), an overload of procurement procedures, or inadequate regulation. The analysis focuses on identifying the most common symptoms of these administrative barriers, including the distribution of procurement procedure types, the occurrence of delays, the proportion of cancelled tenders, and other related indicators. 

### <span style="color:red; font-weight:bold">Is there an overuse of some procedure types?</span>

Requires manual filling

### Regulatory overview of procedure type thresholds and conditions

| Procedure Type                                | Level of competition      | Conditions / When used                                                                                                                                                                                                 | Threshold (value / complexity)                            | Deadline requirements (Submission / Decision) |
|:----------------------------------------------|:--------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:----------------------------------------------------------|:----------------------------------------------|
| Open Procedure                                | Competitive               | Default choice, anyone can bid.                                                                                                                                                                                        | Mandatory above X value, optional below.                  | Submission: ___  /  Decision: ___            |
| Restricted Procedure / approaching bidders    | Competitive but limited   | Used for complex or high-value tenders where only qualified firms are invited to submit full offers.                                                                                                                   | Usually higher value / complex tenders.                   | Submission: ___  /  Decision: ___            |
| Negotiated Procedure with Prior Publication   | Competitive but limited   | Complex projects which cannot have strictly defined requirements in advance; pre-selection of capable suppliers.                                                                                                      | Usually higher value / complex tenders.                   | Submission: ___  /  Decision: ___            |
| Competitive Dialogue                          | Competitive but limited   | The contract is particularly complex and the authority cannot define the technical means to meet its needs, or the legal or financial make-up of the project; pre-selection of capable suppliers.                     | Usually higher value / complex tenders.                   | Submission: ___  /  Decision: ___            |
| Concession                                    | Competitive but limited   | Remuneration for the supplier comes from revenues generated by operating the service or infrastructure; pre-selection of capable suppliers.                                                                           | Usually complex infrastructural / service projects.       | Submission: ___  /  Decision: ___            |
| Innovation Partnership                        | Competitive but limited   | Joint R&D and purchase of innovative product; competitive entry and long-term partnership after; pre-selection of capable suppliers.                                                                                  | Complex / innovative projects.                            | Submission: ___  /  Decision: ___            |
| Design contest                                | Competitive               | Open submission of project designs (architecture, urban planning, engineering, etc.).                                                                                                                                  | Projects requiring design submission.                     | Submission: ___  /  Decision: ___            |
| Mini-tender                                   | Competitive but limited   | Second stage in framework agreements or DPS for pre-selected suppliers; invitation sent only to framework / DPS suppliers qualified for that lot/category.                                                            | Invitation sent only to suppliers qualified for that lot. | Submission: ___  /  Decision: ___            |
| Negotiated Procedure without Prior Publication| Non-competitive           | Contracting authority directly approaches one or more suppliers under exceptional, legally defined conditions. Allowed only under strict circumstances (no competition, extreme urgency, or failed competitive tender). | Allowed only under strict legal circumstances.            | Submission: ___  /  Decision: ___            |
| Direct Award / Single Source                  | Non-competitive           | Direct purchase from supplier without competition. Used for very low-value purchases or specific exceptions.                                                                                                          | Below X value or specific exceptions.                     | Submission: ___  /  Decision: ___            |

**Tendering techniques**

| Tendering technique  | Level of competition    | Conditions / When used                                                                                                                                                                                                                                         | Threshold / relation to procedure                          | Deadlines / relation to procedure             |
|:---------------------|:------------------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-----------------------------------------------------------|:----------------------------------------------|
| Dynamic Purchasing System (DPS) | Competitive              | Electronic system for recurring, standard items. Suppliers can apply to join at any time.                                                                                                                                                                      | Same as for open / mini-tender.                           | Same as for open / mini-tender.              |
| Framework Agreement  | Competitive but limited | Long-term contract arrangement between one or more contracting authorities and one or more suppliers that sets terms (price, quantities, quality, etc.) for future purchases. Can result in a single supplier (no competition at second stage) or multiple suppliers (mini-tender at second stage). | Depending on the underlying procedure(s) used.             | Depending on the underlying procedure(s).     |

*Source: relevant regulations; MAPS, etc.*

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo   = TRUE,     # show code; set to FALSE if you want a clean report
  message = FALSE,
  warning = FALSE,
  fig.width  = 10,
  fig.height = 6
)
knitr::opts_chunk$set(fig.width = 10, fig.height = 6)

# Source your helper + pipeline functions
source("C:/Users/wb589991/OneDrive - WBG/Documents/procuR.github.io/admin_utils.R")

# Load packages
required_packages <- c(
  "data.table", "tidyverse", "patchwork", "corrr",
  "giscoR", "eurostat", "sf", "tidytext",
  "fixest", "ggeffects", "igraph", "ggraph", "purrr"
)

load_packages <- function(pkgs) {
  installed  <- rownames(installed.packages())
  to_install <- setdiff(pkgs, installed)
  if (length(to_install) > 0) install.packages(to_install)
  invisible(lapply(pkgs, library, character.only = TRUE))
}

load_packages(required_packages)
```

```{r multi-country-setup, include=FALSE}
base_dir      <- "C:/Users/wb589991/Downloads"
country_codes <- c("BG", "UY" ,"ID")   # <- add more here if needed: "BG", "UY", "RO", ...

results_list <- map(country_codes, function(cc) {
  input_dir  <- file.path(base_dir, paste0(cc, "_export.csv"))
  input_path <- file.path(input_dir, paste0(cc, "_export.csv"))
  output_dir <- input_dir
  
  dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)
  
  df <- load_data(input_path)
  run_admin_efficiency_pipeline(
    df           = df,
    country_code = cc,
    output_dir   = output_dir
  )
})

names(results_list) <- country_codes
```

```{r helpers-report, echo=FALSE}
# Helper to print a ggplot (or message) plus text around it
print_result_plot <- function(results,
                              obj_name,
                              title,
                              description = NULL,
                              missing_msg = "Figure not produced: no information or key variable is missing for the plot.") {
  # Pull object from list by name
  obj <- results[[obj_name]]
  
  # Section title
  cat("#### ", title, "\n\n", sep = "")
  
  # Optional description paragraph
  if (!is.null(description)) {
    cat(description, "\n\n")
  }
  
  # If it's a ggplot, print it
  if (inherits(obj, "gg")) {
    print(obj)
    cat("\n\n")
  } else if (is.null(obj)) {
    # If it's NULL -> no plot
    cat("*", missing_msg, "*\n\n", sep = "")
  } else {
    # Something exists but is not a ggplot (e.g. data frame / model)
    cat("*Object exists but is not a plot (class: ", paste(class(obj), collapse = ", "),
        "). Nothing to draw here.*\n\n", sep = "")
  }
}
```


```{r country-results-helper, include=FALSE}
render_country_results <- function(cc, results_list) {
  # Grab the results object for the country
    # grab the correct results object
  results <- results_list[[cc]]
  summ    <- results$summary_stats
  cat("#### Basic data summary for ", cc, "\n\n", sep = "")
  
  ## ------------------------------------------------------------
  ## Contracts per year
  ## ------------------------------------------------------------
  cat("**Contracts per year:**\n\n")
  if (!is.null(summ$n_obs_per_year)) {
    contracts_tbl <- summ$n_obs_per_year %>%
      as.data.frame()    # in case it's a tibble / data.table
    knitr::kable(
      contracts_tbl,
      col.names = c("Tender year", "Number of contracts"),
      align = c("c", "c")
    ) %>% print()
    cat("\n\n")
  } else {
    cat("_Not available (no `tender_year`)._\n\n")
  }
  
  ## ------------------------------------------------------------
  ## Unique buyers / bidders
  ## ------------------------------------------------------------
  if (!is.na(summ$n_unique_buyers)) {
    cat("**Number of unique buyers (buyer_masterid):** ",
        formatC(summ$n_unique_buyers, big.mark = ","), "\n\n")
  } else {
    cat("**Number of unique buyers:** column `buyer_masterid` not found.\n\n")
  }
  
  if (!is.na(summ$n_unique_bidders)) {
    cat("**Number of unique bidders (bidder_masterid):** ",
        formatC(summ$n_unique_bidders, big.mark = ","), "\n\n")
  } else {
    cat("**Number of unique bidders:** column `bidder_masterid` not found.\n\n")
  }
  
  ## ------------------------------------------------------------
  ## Unique tenders per year
  ## ------------------------------------------------------------
  if (!is.null(summ$tender_year_tenders)) {
    cat("**Number of unique tenders per year:**\n\n")
    tenders_tbl <- summ$tender_year_tenders %>%
      as.data.frame()
    knitr::kable(
      tenders_tbl,
      col.names = c("Tender year", "Number of unique tenders"),
      align = c("c", "c")
    ) %>% print()
    cat("\n\n")
  }
  
  ## ------------------------------------------------------------
  ## Variables present
  ## ------------------------------------------------------------
  cat("**Variables present (excluding indicator variables):**\n\n")
  # bullet list instead of one long line
  cat(paste0("- ", summ$vars_present, collapse = "\n"), "\n\n")
  
  # ================================================================
  # 1. Procedure types: overuse / overreporting
  # ================================================================
  cat(
    "#### <span style=\"color:red; font-weight:bold\">Is there an overuse or overreporting of some procedure types?</span>\n\n",
    sep = ""
  )
  
  print_result_plot(
    results,
    obj_name    = "sh",
    title       = paste("Relative weight of procedure types –", cc),
    description = paste(
      "This panel compares how heavily each procedure type is used or reported in the data.",
      "The figure shows what share of total contract value is awarded under each procedure type.")
  )
  
    print_result_plot(
    results,
    obj_name    = "p_count",
    title       = paste("Relative weight of procedure types –", cc),
    description = paste(
      "This chart shows what share of the total number of contracts each procedure type represents.",
      "Together, they reveal whether certain procedures dominate the system either in volume (many contracts) or in value (large budgets).",
      "Pay particular attention to procedures that are meant to be exceptional or highly regulated – such as direct awards or negotiated procedures but appear with very large shares.",
      "A large gap between the share of contracts and share of value for a given procedure suggests that it is used mainly for very small, or very large, tenders."
    )
  )
  
  # ================================================================
  # 2. Submission periods: is there enough time to bid?
  # ================================================================
  cat(
    "#### <span style=\"color:red; font-weight:bold\">Is there sufficient time for suppliers to prepare and submit bids?</span>\n\n",
    sep = ""
  )
  
  
  print_result_plot(
    results,
    obj_name    = "subm_proc_facet_q",
    title       = paste("Days for bid submission by procedure type –", cc),
    description = paste(
      "Here the length of the submission period is shown separately for each procedure type.",
      "Within each panel, the blue vertical lines indicate the typical range (from lower quartile to upper quartile) and the median number of days suppliers have to submit bids.",
      "Comparing these panels helps identify whether more complex or high-value procedures offer more time, and whether simpler or low-value procedures are systematically rushed.",
      "Watch for procedure types where the entire distribution is shifted towards very short periods,",
      "or where the median is close to the minimum allowed by regulation, as this may constrain meaningful competition."
    )
  )
  
  print_result_plot(
    results,
    obj_name    = "subm_r",
    title       = paste("Short and medium submission periods by procedure type –", cc),
    description = paste(
      "This histogram highlights tenders with particularly short (red) and medium-length (yellow) submission periods, by procedure type.",
      "The colouring is based on country-specific thresholds that approximate what would be considered too short or only barely adequate for preparing a bid.",
      "Panels with a large share of red bars indicate procedure types where suppliers often have very limited time to respond.",
      "Use this chart to identify whether open and restricted procedures – which should normally support strong competition –",
      "are frequently run with deadlines that are difficult to meet, especially for new entrants or foreign suppliers."
    )
  )
  
  # ================================================================
  # 3. Who uses short deadlines? (by buyer group)
  # ================================================================
  print_result_plot(
    results,
    obj_name    = "buyer_short",
    title       = paste("Short submission periods by buyer group (number of contracts) –", cc),
    description = paste(
      "This chart shows, for each broad buyer group, what share of their tenders use short submission periods.",
      "Each bar is split into the proportion of contracts with unusually short deadlines versus those with normal or longer timelines.",
      "Comparing these bars across buyer groups (e.g. national versus regional authorities) helps identify where time pressure on suppliers is most common.",
      "Look for buyer types with systematically higher shares of short deadlines, as this may point to structural practices or capacity issues in those institutions."
    )
  )
  
  print_result_plot(
    results,
    obj_name    = "buyer_short_v",
    title       = paste("Short submission periods by buyer group (contract value) –", cc),
    description = paste(
      "This figure repeats the analysis of short submission periods, but now weighting by contract value instead of number of tenders.",
      "It shows, for each buyer group, the share of total spending that is awarded through tenders with unusually short deadlines.",
      "If a buyer group has relatively few short-deadline tenders in number, but a large share of its budget flows through them,",
      "this suggests that the most financially important awards may be conducted under time frames that limit competition.",
      "Use this plot to distinguish between occasional small ‘rush’ purchases and systematic use of tight deadlines for high-value contracts."
    )
  )
  
  # ================================================================
  # 4. Decision times: are awards being delayed?
  # ================================================================
  cat(
    "#### <span style=\"color:red; font-weight:bold\">Are there significant delays in contract award decisions?</span>\n\n",
    sep = ""
  )
  
  
  print_result_plot(
    results,
    obj_name    = "decp_proc_facet_q",
    title       = paste("Days for award decision by procedure type –", cc),
    description = paste(
      "Here the time from bid submission to award is shown separately for each procedure type.",
      "Within each panel, the blue lines highlight the median and the spread of typical decision times.",
      "This allows you to see whether more complex procedures take appropriately longer to evaluate, and whether simpler procedures are decided more quickly.",
      "Pay attention to procedure types where decisions are routinely much slower than others,",
      "or where complex tenders appear to be decided as quickly as simple ones, which may raise questions about the depth of evaluation."
    )
  )
  
  print_result_plot(
    results,
    obj_name    = "decp_r",
    title       = paste("Long award decision periods by procedure type –", cc),
    description = paste(
      "This chart focuses on very long decision periods, highlighting tenders whose evaluation and award take longer than a country-specific threshold.",
      "Bars in red correspond to tenders with particularly slow decisions, while blue bars represent more timely awards.",
      "A high proportion of red in a given procedure type suggests systematic delays, which can undermine predictability for suppliers and stall public projects.",
      "Use this plot to identify which procedures are most affected by long evaluation times and whether this aligns with their intended complexity."
    )
  )
  
  # ================================================================
  # 5. Who has the longest decisions? (by buyer group)
  # ================================================================
  print_result_plot(
    results,
    obj_name    = "buyer_long",
    title       = paste("Long decision periods by buyer group (number of contracts) –", cc),
    description = paste(
      "This chart shows, for each buyer group, the share of contracts whose decision time exceeds the long-delay threshold.",
      "Each bar is split into contracts with delayed decisions and those decided within a more acceptable time frame.",
      "Comparing across buyer groups reveals where slow decisions are concentrated – for example, whether national-level ministries, regional authorities, or other public bodies are more frequently responsible for delays.",
      "High shares of delayed decisions in a specific buyer group may indicate bottlenecks in evaluation, internal approval, or oversight procedures."
    )
  )
  
  print_result_plot(
    results,
    obj_name    = "buyer_long_v",
    title       = paste("Long decision periods by buyer group (contract value) –", cc),
    description = paste(
      "This figure repeats the delay analysis using contract value rather than number of tenders.",
      "It shows which buyer groups allocate a large share of their spending through tenders with very slow decisions.",
      "If delayed decisions are mostly associated with high-value contracts, the impact on service delivery and market uncertainty is likely to be more serious.",
      "Use this chart to prioritise where reforms to speed up decision-making would have the largest financial impact."
    )
  )
  
  # ================================================================
  # 6. Does administrative efficiency affect competition?
  # ================================================================
  cat(
    "#### <span style=\"color:red; font-weight:bold\">Is administrative efficiency linked to prices and competition?</span>\n\n",
    sep = ""
  )
  
  print_result_plot(
    results,
    obj_name    = "plot_short_reg",
    title       = paste("Effect of short submission periods on single bidding –", cc),
    description = paste(
      "This figure summarises how the likelihood of having only one bidder changes when submission periods are unusually short.",
      "The horizontal axis distinguishes between tenders with normal deadlines and those flagged as short, based on country-specific thresholds.",
      "The vertical axis shows the model-based predicted probability of single bidding, holding constant differences in buyer type and year.",
      "If the line for short deadlines sits noticeably higher, this suggests that tight timelines may be restricting competition and making single bidding more likely.",
      "You can interpret the size of this gap as an indication of how sensitive competition is to the amount of time suppliers are given to prepare bids."
    )
  )
  
  print_result_plot(
    results,
    obj_name    = "plot_long_reg",
    title       = paste("Effect of long decision periods on single bidding –", cc),
    description = paste(
      "This figure assesses whether very long decision periods are associated with a higher likelihood of single bidding.",
      "The horizontal axis compares tenders decided within a normal time frame to those whose award decisions are delayed beyond a country-specific threshold.",
      "The vertical axis shows the predicted probability that only one bidder participates, after accounting for differences in buyer type and year.",
      "A higher predicted probability of single bidding for delayed decisions may indicate strategic behaviour or weakened competitive pressure in tenders that drag on.",
      "Use this chart together with the earlier timing diagnostics to understand whether administrative inefficiencies are merely a capacity issue",
      "or whether they also appear to be linked to reduced competition in practice."
    )
  )
}

```

## Country-specific results {.tabset}

### Bulgaria (BG)
```{r country-BG, echo=FALSE, results='asis'}
render_country_results("BG", results_list)
```

### Uruguat (UY)

```{r country-UY, echo=FALSE, results='asis'}
render_country_results("UY", results_list)
```

### Indonesia (ID)

```{r country-ID, echo=FALSE, results='asis'}
render_country_results("ID", results_list)
```

```{r show-utils, echo=FALSE, results='asis'}
utils_path <- "C:/Users/wb589991/OneDrive - WBG/Documents/procuR.github.io/admin_utils.R"
utils_code <- readLines(utils_path, warn = FALSE)
cat('<details><summary><b>Show underlying code</b></summary>\n')
cat('\n```r\n')
cat(paste(utils_code, collapse = "\n"))
cat('\n```\n')
cat('</details>\n')
```